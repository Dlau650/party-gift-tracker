<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Voice-powered gift tracking app">
  <meta name="theme-color" content="#9333ea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Gift Tracker">
  
  <title>Gift Tracker</title>
  
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icon-192.png">
  <link rel="apple-touch-icon" href="/icon-192.png">
  
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <script>
    const { useState, useEffect } = React;
    const e = React.createElement;

    function App() {
      const [gifts, setGifts] = useState([]);
      const [contacts, setContacts] = useState([]);
      const [isRecording, setIsRecording] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [transcript, setTranscript] = useState('');
      const [recognition, setRecognition] = useState(null);

      useEffect(() => {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          const rec = new SpeechRecognition();
          rec.continuous = false;
          rec.lang = 'en-US';
          rec.onresult = (event) => {
            const text = event.results[0][0].transcript;
            setTranscript(text);
            parseAndAddGift(text);
          };
          rec.onend = () => setIsRecording(false);
          setRecognition(rec);
        }
        const saved = localStorage.getItem('gifts');
        if (saved) setGifts(JSON.parse(saved));
      }, []);

      useEffect(() => {
        localStorage.setItem('gifts', JSON.stringify(gifts));
      }, [gifts]);

      const parseAndAddGift = async (text) => {
  setIsProcessing(true);
  
  try {
    const response = await fetch('/.netlify/functions/parse-gift', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ text: text })
    });

    if (!response.ok) {
      throw new Error('Failed to parse');
    }

    const parsed = await response.json();

    setGifts(prev => [{
      id: Date.now(),
      gifter: parsed.gifter,
      gift: parsed.gift,
      timestamp: new Date().toISOString()
    }, ...prev]);
  } catch (error) {
    console.error('Error parsing:', error);
    setGifts(prev => [{
      id: Date.now(),
      gifter: 'Unknown',
      gift: text,
      timestamp: new Date().toISOString()
    }, ...prev]);
  }
  
  setIsProcessing(false);
};  


      const startRec = () => {
        if (recognition) {
          setTranscript('');
          setIsRecording(true);
          recognition.start();
        }
      };

      const deleteGift = (id) => {
        setGifts(prev => prev.filter(g => g.id !== id));
      };

      const exportCSV = () => {
        const csv = ['Gifter,Gift\n', ...gifts.map(g => `"${g.gifter}","${g.gift}"`)].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gifts-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };

      return e('div', { className: 'min-h-screen bg-gradient-to-br from-pink-50 to-purple-50 p-4' },
        e('div', { className: 'max-w-4xl mx-auto' },
          e('div', { className: 'bg-white rounded-2xl shadow-lg p-6 mb-6' },
            e('h1', { className: 'text-3xl font-bold text-gray-800' }, 'üéÅ Gift Tracker'),
            e('p', { className: 'text-gray-600' }, 'Tap the mic and say who gave what')
          ),
          e('div', { className: 'bg-white rounded-2xl shadow-lg p-8 mb-6 text-center' },
            e('button', {
              onClick: startRec,
              disabled: isRecording || isProcessing,
              className: `w-32 h-32 rounded-full text-5xl ${isRecording ? 'bg-red-500 animate-pulse' : isProcessing ? 'bg-gray-400' : 'bg-gradient-to-br from-pink-500 to-purple-600'} text-white shadow-lg`
            }, isRecording ? '‚èπÔ∏è' : 'üé§'),
            e('p', { className: 'mt-4 text-lg font-medium' }, 
              isProcessing ? 'Processing...' : isRecording ? 'Recording...' : 'Tap to record'
            ),
            transcript && e('div', { className: 'mt-4 p-4 bg-purple-50 rounded-lg' },
              e('p', { className: 'text-sm text-gray-600' }, 'Last recorded:'),
              e('p', { className: 'italic' }, `"${transcript}"`)
            )
          ),
          e('div', { className: 'bg-white rounded-2xl shadow-lg p-6' },
            e('div', { className: 'flex justify-between mb-4' },
              e('h2', { className: 'text-xl font-bold' }, `Gifts (${gifts.length})`),
              gifts.length > 0 && e('button', {
                onClick: exportCSV,
                className: 'px-4 py-2 bg-green-600 text-white rounded-lg'
              }, 'üì• Export')
            ),
            gifts.length === 0 
              ? e('p', { className: 'text-gray-500 text-center py-8' }, 'No gifts yet - tap the mic!')
              : e('div', { className: 'space-y-3' },
                  gifts.map(gift =>
                    e('div', { key: gift.id, className: 'p-4 border rounded-lg flex justify-between items-start' },
                      e('div', { className: 'flex-1' },
                        e('p', { className: 'font-bold text-gray-800 text-lg' }, gift.gifter),
                        e('p', { className: 'text-gray-600' }, gift.gift)
                      ),
                      e('button', {
                        onClick: () => deleteGift(gift.id),
                        className: 'text-red-600 text-xl ml-4'
                      }, 'üóëÔ∏è')
                    )
                  )
                )
          ),
          e('div', { className: 'mt-6 p-4 bg-white rounded-lg shadow text-sm text-gray-600' },
            e('p', { className: 'font-semibold mb-2' }, 'üí° How it works:'),
            e('p', { className: 'mb-2' }, 'Tap the microphone and say something like:'),
            e('ul', { className: 'list-disc list-inside space-y-1 ml-2' },
              e('li', {}, '"Sarah gave us a blanket"'),
              e('li', {}, '"From Aunt Lisa, a $50 gift card"'),
              e('li', {}, '"John and Mary brought a stroller"')
            ),
            e('p', { className: 'mt-2' }, 'The app automatically separates who gave it from what they gave!')
          )
        )
      );
      
    }
    ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>